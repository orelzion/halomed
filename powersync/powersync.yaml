# PowerSync Sync Rules Configuration
# Reference: sync.md Section 3, TDD Section 8.2
# This file defines which data syncs to client applications

bucket_definitions:
  # User-specific study logs
  # Syncs only the current user's study logs within 14-day rolling window
  user_data:
    parameters:
      - user_id: token.user_id
    data:
      - SELECT id, user_id, track_id, study_date, content_id, is_completed, completed_at
        FROM user_study_log
        WHERE user_id = bucket.user_id
          AND study_date >= CURRENT_DATE - INTERVAL '14 days'
          AND study_date <= CURRENT_DATE + INTERVAL '14 days'

  # Shared content (read-only)
  # Syncs only content referenced by user's scheduled units within 14-day window
  content:
    data:
      - SELECT id, ref_id, source_text_he, ai_explanation_json, he_ref, created_at
        FROM content_cache
        WHERE id IN (
          SELECT content_id FROM user_study_log 
          WHERE user_id = bucket.user_id
            AND study_date >= CURRENT_DATE - INTERVAL '14 days'
            AND study_date <= CURRENT_DATE + INTERVAL '14 days'
        )

  # Track definitions (read-only)
  # Syncs all tracks to all clients
  tracks:
    data:
      - SELECT id, title, source_endpoint, schedule_type, start_date
        FROM tracks

  # User preferences (user-scoped)
  # Syncs only the current user's preferences
  user_preferences:
    parameters:
      - user_id: token.user_id
    data:
      - SELECT id, user_id, pace, review_intensity, streak_count, last_study_date, created_at, updated_at
        FROM user_preferences
        WHERE user_id = bucket.user_id

  # Learning path (user-scoped)
  # Syncs past and future nodes within 60-day window for the current user
  learning_path:
    parameters:
      - user_id: token.user_id
    data:
      - SELECT id, user_id, node_index, node_type, content_ref, tractate, chapter, is_divider, unlock_date, completed_at, review_of_node_id, created_at
        FROM learning_path
        WHERE user_id = bucket.user_id
          AND unlock_date <= CURRENT_DATE + INTERVAL '60 days'

  # Quiz questions (read-only)
  # Syncs quiz questions for content referenced by user's learning path
  quiz_questions:
    parameters:
      - user_id: token.user_id
    data:
      - SELECT id, content_ref, question_index, question_text, options, correct_answer, explanation, created_at
        FROM quiz_questions
        WHERE content_ref IN (
          SELECT DISTINCT content_ref FROM learning_path
          WHERE user_id = bucket.user_id
            AND content_ref IS NOT NULL
            AND unlock_date <= CURRENT_DATE + INTERVAL '60 days'
        )