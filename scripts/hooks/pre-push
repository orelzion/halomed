#!/bin/bash

# Pre-push hook: Run TypeScript build check before pushing
# This catches type errors that would fail on Vercel
# Enhanced to use the comprehensive TypeScript validation script

echo "üîç Running pre-push production checks..."

REPO_ROOT="$(git rev-parse --show-toplevel)"
SCRIPT_DIR="$REPO_ROOT/scripts"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

FAILED=0

print_error() {
    echo -e "${RED}‚ùå $1${NC}"
    FAILED=1
}

print_success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

# Run the comprehensive TypeScript validation script with build check
if [ -f "$SCRIPT_DIR/typescript-check.sh" ]; then
    if ! bash "$SCRIPT_DIR/typescript-check.sh" --build-check; then
        print_error "TypeScript validation failed"
        echo "See details above or run: bash scripts/typescript-check.sh --build-check"
    else
        print_success "TypeScript validation passed"
    fi
else
    print_warning "TypeScript check script not found at scripts/typescript-check.sh"
    echo "Falling back to basic TypeScript check..."
    
    # Fallback: Basic TypeScript check
    cd "$REPO_ROOT/web" || exit 1
    if ! npx tsc --noEmit; then
        print_error "TypeScript errors found"
        echo "Fix the errors above and try again."
    fi
fi

# Additional production checks
echo ""
echo "üèóÔ∏è  Running additional production checks..."

# Check for environment variables template
if [ ! -f "$REPO_ROOT/.env.example" ]; then
    print_warning ".env.example not found - consider creating one for new contributors"
fi

# Check gitignore for security patterns
if [ -f "$REPO_ROOT/.gitignore" ]; then
    REQUIRED_PATTERNS=(".env" "*.key" "*.pem" "secrets.json")
    for pattern in "${REQUIRED_PATTERNS[@]}"; do
        if ! grep -q "$pattern" "$REPO_ROOT/.gitignore"; then
            print_warning ".gitignore missing '$pattern' pattern"
        fi
    done
fi

if [ $FAILED -eq 1 ]; then
    echo ""
    echo "‚ùå Pre-push checks failed. Push aborted."
    echo "Fix the issues above and try again."
    exit 1
fi

echo ""
echo "‚úÖ All pre-push checks passed!"
echo "üöÄ Ready to push to remote"
exit 0
