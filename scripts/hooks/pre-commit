#!/bin/bash

# Pre-commit hook: Security and Regulations scanning
# Enhanced to use comprehensive scripts with TypeScript checking
# Based on .claude/agents/security.md and .claude/agents/regulations.md

echo "ðŸ”’ Running production readiness checks..."

# Get repository root
REPO_ROOT="$(git rev-parse --show-toplevel)"
SCRIPT_DIR="$REPO_ROOT/scripts"

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo "âœ… No staged files to check"
    exit 0
fi

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

FAILED=0

# Function to print section headers
print_section() {
    echo -e "\n${BLUE}=== $1 ===${NC}"
}

# Function to print success
print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

# Function to print warning
print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

# Function to print error
print_error() {
    echo -e "${RED}âŒ $1${NC}"
    FAILED=1
}

print_section "SECURITY VALIDATION (@security)"

# Run the comprehensive security check script
if [ -f "$SCRIPT_DIR/security-check.sh" ]; then
    if ! bash "$SCRIPT_DIR/security-check.sh"; then
        print_error "Security validation failed"
        echo "See details above or run: bash scripts/security-check.sh"
    else
        print_success "Security validation passed"
    fi
else
    print_warning "Security check script not found at scripts/security-check.sh"
    echo "Consider running: bash scripts/setup-hooks.sh"
fi

print_section "REGULATIONS COMPLIANCE (@regulations)"

# Run the comprehensive regulations check script
if [ -f "$SCRIPT_DIR/regulations-check.sh" ]; then
    if ! bash "$SCRIPT_DIR/regulations-check.sh"; then
        print_error "Regulations compliance check failed"
        echo "See details above or run: bash scripts/regulations-check.sh"
    else
        print_success "Regulations compliance check passed"
    fi
else
    print_warning "Regulations check script not found at scripts/regulations-check.sh"
    echo "Consider running: bash scripts/setup-hooks.sh"
fi

print_section "TYPESCRIPT VALIDATION"

# Check for TypeScript files and run type checking
STAGED_TS_JS_FILES=$(echo "$STAGED_FILES" | grep -E "\.(ts|tsx|js|jsx)$" || true)
if [[ -n "$STAGED_TS_JS_FILES" ]] && [[ -d "$REPO_ROOT/web" ]]; then
    echo "Running TypeScript type checking..."
    
    cd "$REPO_ROOT/web"
    
    # Check if TypeScript is available
    if command -v npx >/dev/null 2>&1 && [[ -f "package.json" ]]; then
        if npx tsc --noEmit 2>/dev/null; then
            print_success "TypeScript type checking passed"
        else
            print_error "TypeScript type checking failed"
            echo "Run 'cd web && npx tsc --noEmit' to see detailed errors"
        fi
    else
        print_warning "TypeScript compiler not available - skipping type check"
        echo "Install dependencies with: cd web && npm install"
    fi
    
    cd "$REPO_ROOT"
else
    print_success "No TypeScript files to check"
fi

if [ $FAILED -eq 1 ]; then
    echo ""
    print_error "Production readiness checks failed"
    echo ""
    echo "Please fix the issues above before committing."
    echo "For help, consult:"
    echo "  - .claude/agents/security.md (Security guidelines)"
    echo "  - .claude/agents/regulations.md (Regulations compliance)"
    echo "  - scripts/security-check.sh (Security script details)"
    echo "  - scripts/regulations-check.sh (Regulations script details)"
    echo ""
    echo "To bypass these checks (not recommended):"
    echo "  git commit --no-verify"
    exit 1
fi

echo ""
print_success "All production readiness checks passed! âœ¨"
echo "ðŸš€ Your code is ready for production deployment"

exit 0
