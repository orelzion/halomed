---
phase: 01-analytics-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - supabase/migrations/202601XX_create_engagement_analytics_views.sql
autonomous: true

must_haves:
  truths:
    - "System can query review session usage frequency"
    - "System can query explanation engagement rates"
    - "Only admins can access these analytics views"
  artifacts:
    - path: "supabase/migrations/20260128100006_create_engagement_analytics_views.sql"
      provides: "Review and explanation engagement views"
      contains: "CREATE MATERIALIZED VIEW analytics."
  key_links:
    - from: "analytics.review_session_usage"
      to: "learning_path"
      via: "aggregation on review nodes"
      pattern: "node_type.*review"
    - from: "analytics.explanation_engagement"
      to: "learning_path"
      via: "aggregation on learning nodes"
      pattern: "node_type.*learning"
---

<objective>
Create engagement analytics views for review sessions and explanation tracking.

Purpose: Implements the secondary analytics metrics (Review Session Usage, Explanation Engagement) as PostgreSQL materialized views. These views track which features users actually use beyond basic learning completion.

Output: SQL migration creating 2 additional materialized views with admin-only access functions.
</objective>

<execution_context>
@/Users/orelzion/.claude/get-shit-done/workflows/execute-plan.md
@/Users/orelzion/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-analytics-foundation/01-01-SUMMARY.md

# Source tables for analytics
@supabase/migrations/20260117221634_create_learning_path_table.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create review session usage view</name>
  <files>
    supabase/migrations/20260128100006_create_engagement_analytics_views.sql
  </files>
  <action>
Create SQL migration with materialized views for review and engagement metrics.

**1. Review Session Usage (ANLYT-05)**

Tracks how often users engage with review sessions (spaced repetition nodes):

```sql
-- Review session usage analytics
-- Tracks: ANLYT-05 (review session usage frequency)
CREATE MATERIALIZED VIEW analytics.review_session_usage AS
SELECT
  DATE_TRUNC('week', unlock_date)::date as week_start,
  COUNT(DISTINCT user_id) as users_with_reviews,
  COUNT(*) as total_review_nodes,
  COUNT(*) FILTER (WHERE completed_at IS NOT NULL) as completed_reviews,
  ROUND(
    COUNT(*) FILTER (WHERE completed_at IS NOT NULL)::NUMERIC /
    NULLIF(COUNT(*), 0) * 100,
    2
  ) as review_completion_rate_pct,
  AVG(
    CASE WHEN completed_at IS NOT NULL
    THEN EXTRACT(EPOCH FROM (completed_at - unlock_date::timestamp)) / 86400.0
    ELSE NULL END
  )::NUMERIC(10,2) as avg_days_to_complete
FROM learning_path
WHERE node_type = 'review'
  AND unlock_date >= CURRENT_DATE - INTERVAL '90 days'
GROUP BY DATE_TRUNC('week', unlock_date)
ORDER BY week_start DESC;

CREATE UNIQUE INDEX idx_review_usage_week ON analytics.review_session_usage(week_start);

COMMENT ON MATERIALIZED VIEW analytics.review_session_usage IS
  'Review session usage frequency by week. Tracks ANLYT-05. Refreshed via pg_cron.';
```

**2. Explanation Engagement (ANLYT-06)**

Note: The current schema does not have explicit explanation view tracking. Based on research open question #2, we need to define what constitutes "explanation engagement."

For MVP, we track learning node completion as a proxy for engagement (users who complete learning nodes are assumed to have engaged with explanations). Future enhancement could add explicit `explanation_opened_at` timestamp.

```sql
-- Explanation engagement analytics (proxy via learning completion)
-- Tracks: ANLYT-06 (explanation engagement)
-- Note: Uses learning completion as proxy. Future: add explicit explanation tracking.
CREATE MATERIALIZED VIEW analytics.explanation_engagement AS
SELECT
  DATE_TRUNC('week', unlock_date)::date as week_start,
  COUNT(DISTINCT user_id) as users_with_learning,
  COUNT(*) as total_learning_nodes,
  COUNT(*) FILTER (WHERE completed_at IS NOT NULL) as completed_learning,
  ROUND(
    COUNT(*) FILTER (WHERE completed_at IS NOT NULL)::NUMERIC /
    NULLIF(COUNT(*), 0) * 100,
    2
  ) as engagement_rate_pct,
  -- Track average time from unlock to completion (indicates engagement depth)
  AVG(
    CASE WHEN completed_at IS NOT NULL
    THEN EXTRACT(EPOCH FROM (completed_at - unlock_date::timestamp)) / 3600.0
    ELSE NULL END
  )::NUMERIC(10,2) as avg_hours_to_complete
FROM learning_path
WHERE node_type = 'learning'
  AND unlock_date >= CURRENT_DATE - INTERVAL '90 days'
GROUP BY DATE_TRUNC('week', unlock_date)
ORDER BY week_start DESC;

CREATE UNIQUE INDEX idx_explanation_engagement_week ON analytics.explanation_engagement(week_start);

COMMENT ON MATERIALIZED VIEW analytics.explanation_engagement IS
  'Explanation engagement (proxy via learning completion). Tracks ANLYT-06. Future: add explicit explanation click tracking.';
```

**3. Add wrapper functions for admin access:**

```sql
-- Wrapper function for review session usage
CREATE OR REPLACE FUNCTION analytics.get_review_session_usage()
RETURNS SETOF analytics.review_session_usage AS $$
BEGIN
  IF NOT public.is_admin() THEN
    RAISE EXCEPTION 'Access denied: Admin role required';
  END IF;
  RETURN QUERY SELECT * FROM analytics.review_session_usage;
END;
$$ LANGUAGE plpgsql STABLE SECURITY DEFINER;

-- Wrapper function for explanation engagement
CREATE OR REPLACE FUNCTION analytics.get_explanation_engagement()
RETURNS SETOF analytics.explanation_engagement AS $$
BEGIN
  IF NOT public.is_admin() THEN
    RAISE EXCEPTION 'Access denied: Admin role required';
  END IF;
  RETURN QUERY SELECT * FROM analytics.explanation_engagement;
END;
$$ LANGUAGE plpgsql STABLE SECURITY DEFINER;

-- Grant execute to authenticated
GRANT EXECUTE ON FUNCTION analytics.get_review_session_usage TO authenticated;
GRANT EXECUTE ON FUNCTION analytics.get_explanation_engagement TO authenticated;

-- Revoke direct access
REVOKE ALL ON analytics.review_session_usage FROM authenticated, anon;
REVOKE ALL ON analytics.explanation_engagement FROM authenticated, anon;
```
  </action>
  <verify>
After applying migration:
```sql
-- Verify views exist
SELECT matviewname FROM pg_matviews WHERE schemaname = 'analytics';
-- Should include: review_session_usage, explanation_engagement

-- Verify indexes
SELECT indexname FROM pg_indexes WHERE schemaname = 'analytics' AND tablename IN ('review_session_usage', 'explanation_engagement');

-- Verify functions
SELECT routine_name FROM information_schema.routines
WHERE routine_schema = 'analytics' AND routine_name LIKE '%review%' OR routine_name LIKE '%explanation%';
```
  </verify>
  <done>
- review_session_usage materialized view created
- explanation_engagement materialized view created (proxy metric)
- Wrapper functions with admin check created
- Direct access revoked
  </done>
</task>

<task type="auto">
  <name>Task 2: Create summary statistics view</name>
  <files>
    supabase/migrations/20260128100007_create_analytics_summary.sql
  </files>
  <action>
Create a summary view that provides high-level KPIs for quick admin overview.

**Summary Statistics View:**

```sql
-- High-level analytics summary for admin dashboard
CREATE MATERIALIZED VIEW analytics.summary_stats AS
SELECT
  -- User counts
  (SELECT COUNT(DISTINCT user_id) FROM user_study_log) as total_users,
  (SELECT COUNT(DISTINCT user_id) FROM user_study_log
   WHERE study_date >= CURRENT_DATE - INTERVAL '7 days' AND is_completed) as active_users_7d,
  (SELECT COUNT(DISTINCT user_id) FROM user_study_log
   WHERE study_date >= CURRENT_DATE - INTERVAL '30 days' AND is_completed) as active_users_30d,

  -- Completion metrics
  (SELECT ROUND(AVG(CASE WHEN is_completed THEN 1.0 ELSE 0.0 END) * 100, 2)
   FROM user_study_log WHERE study_date >= CURRENT_DATE - INTERVAL '30 days') as completion_rate_30d,

  -- Quiz metrics
  (SELECT ROUND(
    COUNT(*) FILTER (WHERE completed_at IS NOT NULL)::NUMERIC /
    NULLIF(COUNT(*), 0) * 100, 2)
   FROM learning_path WHERE node_type = 'quiz' AND unlock_date >= CURRENT_DATE - INTERVAL '30 days') as quiz_completion_rate_30d,

  -- Review metrics
  (SELECT ROUND(
    COUNT(*) FILTER (WHERE completed_at IS NOT NULL)::NUMERIC /
    NULLIF(COUNT(*), 0) * 100, 2)
   FROM learning_path WHERE node_type = 'review' AND unlock_date >= CURRENT_DATE - INTERVAL '30 days') as review_completion_rate_30d,

  -- Metadata
  NOW() as refreshed_at;

-- No unique index needed (single row)
CREATE UNIQUE INDEX idx_summary_stats_singleton ON analytics.summary_stats((1));

COMMENT ON MATERIALIZED VIEW analytics.summary_stats IS
  'High-level KPI summary for admin dashboard. Single row with aggregated stats. Refreshed via pg_cron.';

-- Wrapper function
CREATE OR REPLACE FUNCTION analytics.get_summary_stats()
RETURNS analytics.summary_stats AS $$
BEGIN
  IF NOT public.is_admin() THEN
    RAISE EXCEPTION 'Access denied: Admin role required';
  END IF;
  RETURN (SELECT s FROM analytics.summary_stats s LIMIT 1);
END;
$$ LANGUAGE plpgsql STABLE SECURITY DEFINER;

GRANT EXECUTE ON FUNCTION analytics.get_summary_stats TO authenticated;
REVOKE ALL ON analytics.summary_stats FROM authenticated, anon;
```
  </action>
  <verify>
```sql
-- Verify summary view exists
SELECT matviewname FROM pg_matviews WHERE matviewname = 'summary_stats';

-- Test refresh
REFRESH MATERIALIZED VIEW analytics.summary_stats;

-- Query (as admin)
SELECT * FROM analytics.get_summary_stats();
```
  </verify>
  <done>
- summary_stats materialized view created with high-level KPIs
- Wrapper function with admin check
- Single-row structure for quick overview
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Verify all engagement views exist:**
   ```sql
   SELECT matviewname FROM pg_matviews WHERE schemaname = 'analytics';
   -- Should include: review_session_usage, explanation_engagement, summary_stats
   ```

2. **Verify all functions exist:**
   ```sql
   SELECT routine_name FROM information_schema.routines WHERE routine_schema = 'analytics';
   -- Should include: get_review_session_usage, get_explanation_engagement, get_summary_stats
   ```

3. **Test summary stats:**
   ```sql
   REFRESH MATERIALIZED VIEW analytics.summary_stats;
   SELECT * FROM analytics.summary_stats;
   ```
</verification>

<success_criteria>
- review_session_usage view tracks ANLYT-05
- explanation_engagement view tracks ANLYT-06 (proxy metric)
- summary_stats provides quick KPI overview
- All views have admin-only wrapper functions
- `supabase db push` applies without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-analytics-foundation/01-03-SUMMARY.md`
</output>
