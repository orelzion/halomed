---
phase: 02-admin-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - web/package.json
  - web/next.config.ts
  - web/middleware.ts
  - web/lib/supabase/server.ts
  - web/app/admin/layout.tsx
  - web/app/admin/forbidden.tsx
  - web/types/analytics.ts
autonomous: true

must_haves:
  truths:
    - "Non-authenticated users visiting /admin/* are redirected to login"
    - "Server Components can create Supabase clients that read cookies"
    - "TypeScript types exist for all analytics RPC return values"
  artifacts:
    - path: "web/middleware.ts"
      provides: "Route-level auth check for /admin/* paths"
      contains: "matcher.*admin"
    - path: "web/lib/supabase/server.ts"
      provides: "Server-side Supabase client factory"
      exports: ["createClient"]
    - path: "web/types/analytics.ts"
      provides: "TypeScript interfaces for analytics data"
      contains: "SummaryStats"
    - path: "web/app/admin/layout.tsx"
      provides: "Admin section layout wrapper"
      min_lines: 10
    - path: "web/app/admin/forbidden.tsx"
      provides: "Custom 403 page for unauthorized access"
      min_lines: 10
  key_links:
    - from: "web/middleware.ts"
      to: "@supabase/ssr"
      via: "createServerClient import"
      pattern: "createServerClient"
    - from: "web/next.config.ts"
      to: "experimental.authInterrupts"
      via: "config flag"
      pattern: "authInterrupts.*true"
---

<objective>
Install dependencies and create admin route protection infrastructure

Purpose: Establish the foundation for secure admin-only access to the analytics dashboard using Next.js middleware and Supabase server-side authentication. This enables subsequent UI work to focus purely on presentation.

Output: Working route protection that redirects unauthenticated users, server-side Supabase client for data fetching, TypeScript types for analytics data, and admin layout/error pages.
</objective>

<execution_context>
@/Users/orelzion/.claude/get-shit-done/workflows/execute-plan.md
@/Users/orelzion/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-admin-dashboard/02-RESEARCH.md

# Phase 1 established the database security layer
@.planning/phases/01-analytics-foundation/01-01-SUMMARY.md
@.planning/phases/01-analytics-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and enable authInterrupts</name>
  <files>web/package.json, web/next.config.ts</files>
  <action>
    1. Install recharts and date-fns:
       ```bash
       cd web && npm install recharts date-fns
       ```

    2. Update next.config.ts to enable experimental authInterrupts (required for forbidden() function):
       - Add `experimental: { authInterrupts: true }` to nextConfig object
       - Keep existing turbopack, rewrites, webpack config unchanged
  </action>
  <verify>
    - `cat web/package.json | grep recharts` shows version
    - `cat web/package.json | grep date-fns` shows version
    - `grep -A2 "experimental" web/next.config.ts` shows authInterrupts: true
  </verify>
  <done>
    - recharts and date-fns installed in web/package.json
    - next.config.ts has experimental.authInterrupts enabled
  </done>
</task>

<task type="auto">
  <name>Task 2: Create server-side Supabase client and middleware</name>
  <files>web/lib/supabase/server.ts, web/middleware.ts</files>
  <action>
    1. Create web/lib/supabase/server.ts - Server-side Supabase client factory:
       ```typescript
       import { createServerClient } from '@supabase/ssr'
       import { cookies } from 'next/headers'

       export async function createClient() {
         const cookieStore = await cookies()

         return createServerClient(
           process.env.NEXT_PUBLIC_SUPABASE_URL!,
           process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
           {
             cookies: {
               get(name: string) {
                 return cookieStore.get(name)?.value
               },
             },
           }
         )
       }
       ```

    2. Create web/middleware.ts - Route protection for /admin/* paths:
       ```typescript
       import { createServerClient } from '@supabase/ssr'
       import { NextResponse } from 'next/server'
       import type { NextRequest } from 'next/server'

       export async function middleware(request: NextRequest) {
         const response = NextResponse.next()

         const supabase = createServerClient(
           process.env.NEXT_PUBLIC_SUPABASE_URL!,
           process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
           {
             cookies: {
               get(name: string) {
                 return request.cookies.get(name)?.value
               },
               set(name: string, value: string, options: any) {
                 response.cookies.set({ name, value, ...options })
               },
               remove(name: string, options: any) {
                 response.cookies.set({ name, value: '', ...options })
               },
             },
           }
         )

         const { data: { session } } = await supabase.auth.getSession()

         // Redirect to login if not authenticated
         if (request.nextUrl.pathname.startsWith('/admin')) {
           if (!session) {
             return NextResponse.redirect(new URL('/auth/login', request.url))
           }
         }

         return response
       }

       export const config = {
         matcher: ['/admin/:path*'],
       }
       ```

    NOTE: Middleware only checks authentication (session exists). Admin role validation happens in Server Components via RPC calls that enforce is_admin() at database level.
  </action>
  <verify>
    - `cat web/lib/supabase/server.ts` shows createClient export
    - `cat web/middleware.ts` shows matcher for /admin/:path*
    - TypeScript compiles without errors: `cd web && npx tsc --noEmit`
  </verify>
  <done>
    - Server-side Supabase client factory exists at web/lib/supabase/server.ts
    - Middleware redirects unauthenticated users from /admin/* to /auth/login
  </done>
</task>

<task type="auto">
  <name>Task 3: Create TypeScript types and admin layout</name>
  <files>web/types/analytics.ts, web/app/admin/layout.tsx, web/app/admin/forbidden.tsx</files>
  <action>
    1. Create web/types/analytics.ts - TypeScript interfaces matching Phase 1 RPC return types:
       ```typescript
       // Types for analytics RPC function return values
       // Must match PostgreSQL function signatures from Phase 1 migrations

       export interface SummaryStats {
         total_users: number
         active_users_7d: number
         active_users_30d: number
         completion_rate_30d: number
         quiz_completion_rate_30d: number
         review_completion_rate_30d: number
         refreshed_at: string
       }

       export interface PopularTrack {
         track_id: string
         track_title: string
         total_users: number
         total_completions: number
         total_scheduled: number
         completion_rate_pct: number
       }

       export interface StreakDropoff {
         days_before_dropoff: number
         num_streaks_ended: number
         percentage: number
       }

       export interface QuizCompletionRate {
         week_start: string
         users_with_quizzes: number
         total_quizzes: number
         completed_quizzes: number
         completion_rate_pct: number
       }

       export interface ReviewSessionUsage {
         week_start: string
         users_with_reviews: number
         total_reviews: number
         completed_reviews: number
         completion_rate_pct: number
         avg_days_to_complete: number | null
       }

       export interface ExplanationEngagement {
         week_start: string
         users_with_learning: number
         total_learning: number
         completed_learning: number
         engagement_rate_pct: number
         avg_hours_to_complete: number | null
       }

       export interface HealthCheck {
         view_name: string
         row_count: number
         refreshed_at: string | null
       }

       // Date range filter type
       export type DateRange = '1d' | '7d' | '30d'
       ```

    2. Create web/app/admin/layout.tsx - Admin section layout:
       ```typescript
       import { Metadata } from 'next'

       export const metadata: Metadata = {
         title: 'Admin Dashboard | HaLomeid',
         description: 'Analytics dashboard for HaLomeid administrators',
       }

       export default function AdminLayout({
         children,
       }: {
         children: React.ReactNode
       }) {
         return (
           <div className="min-h-screen bg-secondary" dir="ltr">
             <header className="bg-card border-b border-muted px-6 py-4">
               <div className="max-w-7xl mx-auto flex items-center justify-between">
                 <h1 className="text-xl font-bold text-foreground">
                   HaLomeid Admin
                 </h1>
                 <a
                   href="/"
                   className="text-sm text-muted-foreground hover:text-foreground transition-colors"
                 >
                   Back to App
                 </a>
               </div>
             </header>
             <main className="max-w-7xl mx-auto px-6 py-8">
               {children}
             </main>
           </div>
         )
       }
       ```
       NOTE: dir="ltr" because admin dashboard is in English (internal tool), even though main app is RTL Hebrew.

    3. Create web/app/admin/forbidden.tsx - Custom 403 error page:
       ```typescript
       export default function ForbiddenPage() {
         return (
           <div className="flex flex-col items-center justify-center min-h-[60vh] text-center">
             <h1 className="text-4xl font-bold text-foreground mb-4">
               403 - Access Denied
             </h1>
             <p className="text-muted-foreground mb-6">
               You do not have permission to access this page.
               <br />
               Only administrators can view the analytics dashboard.
             </p>
             <a
               href="/"
               className="px-6 py-2 bg-accent text-white rounded-lg hover:opacity-90 transition-opacity"
             >
               Return to Home
             </a>
           </div>
         )
       }
       ```
  </action>
  <verify>
    - `cat web/types/analytics.ts` shows SummaryStats, PopularTrack interfaces
    - `cat web/app/admin/layout.tsx` shows AdminLayout component
    - `cat web/app/admin/forbidden.tsx` shows ForbiddenPage component
    - TypeScript compiles: `cd web && npx tsc --noEmit`
  </verify>
  <done>
    - TypeScript types for all analytics data exist at web/types/analytics.ts
    - Admin layout with header and "Back to App" link at web/app/admin/layout.tsx
    - Custom 403 page for unauthorized access at web/app/admin/forbidden.tsx
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Dependency check:**
   ```bash
   cd web && npm ls recharts date-fns
   ```

2. **Config check:**
   ```bash
   grep -A2 "experimental" web/next.config.ts
   ```

3. **File existence:**
   ```bash
   ls -la web/middleware.ts web/lib/supabase/server.ts web/types/analytics.ts web/app/admin/layout.tsx web/app/admin/forbidden.tsx
   ```

4. **TypeScript compilation:**
   ```bash
   cd web && npx tsc --noEmit
   ```

5. **Development server starts:**
   ```bash
   cd web && npm run dev &
   sleep 5
   curl -I http://localhost:3000/admin/analytics
   # Should redirect to /auth/login (302)
   ```
</verification>

<success_criteria>
- recharts and date-fns installed
- next.config.ts has experimental.authInterrupts: true
- Middleware exists and redirects unauthenticated /admin/* requests
- Server-side Supabase client factory exists
- TypeScript types defined for all analytics data structures
- Admin layout and 403 page exist
- TypeScript compiles without errors
- Dev server starts successfully
</success_criteria>

<output>
After completion, create `.planning/phases/02-admin-dashboard/02-01-SUMMARY.md`
</output>
