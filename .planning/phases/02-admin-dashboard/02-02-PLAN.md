---
phase: 02-admin-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - web/app/admin/analytics/page.tsx
  - web/app/admin/analytics/actions.ts
  - web/app/admin/analytics/_components/SummaryCards.tsx
  - web/app/admin/analytics/_components/PopularTracksChart.tsx
  - web/app/admin/analytics/_components/StreakDropoffsChart.tsx
  - web/app/admin/analytics/_components/QuizCompletionChart.tsx
  - web/app/admin/analytics/_components/DateRangeFilter.tsx
  - web/app/admin/analytics/_components/RefreshButton.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can access /admin/analytics page and see metrics"
    - "Non-admin authenticated users see 403 Forbidden page"
    - "Dashboard displays charts for popular tracks, streaks, and quiz completion"
    - "Admin can filter by date range (last day, week, month)"
    - "Admin can manually refresh data"
  artifacts:
    - path: "web/app/admin/analytics/page.tsx"
      provides: "Server Component that fetches analytics and validates admin"
      contains: "supabase.rpc"
      min_lines: 50
    - path: "web/app/admin/analytics/_components/PopularTracksChart.tsx"
      provides: "Bar chart for track popularity"
      contains: "BarChart"
    - path: "web/app/admin/analytics/_components/DateRangeFilter.tsx"
      provides: "URL-based date range selector"
      contains: "useSearchParams"
    - path: "web/app/admin/analytics/_components/RefreshButton.tsx"
      provides: "Manual refresh button with Server Action"
      contains: "refreshAnalytics"
  key_links:
    - from: "web/app/admin/analytics/page.tsx"
      to: "analytics RPC functions"
      via: "supabase.rpc() calls"
      pattern: "rpc\\('get_"
    - from: "web/app/admin/analytics/page.tsx"
      to: "web/app/admin/forbidden.tsx"
      via: "forbidden() call on access denied"
      pattern: "forbidden\\(\\)"
    - from: "web/app/admin/analytics/_components/RefreshButton.tsx"
      to: "web/app/admin/analytics/actions.ts"
      via: "Server Action import"
      pattern: "refreshAnalytics"
---

<objective>
Build the analytics dashboard UI with charts, filters, and manual refresh

Purpose: Create a functional admin dashboard that displays all engagement metrics from Phase 1 analytics views. This is the user-facing portion that makes analytics data accessible to administrators.

Output: Complete analytics dashboard at /admin/analytics with summary cards, interactive charts, date range filtering, and manual refresh capability. Admins see data; non-admins see 403.
</objective>

<execution_context>
@/Users/orelzion/.claude/get-shit-done/workflows/execute-plan.md
@/Users/orelzion/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-admin-dashboard/02-RESEARCH.md

# Prior plan in this phase
@.planning/phases/02-admin-dashboard/02-01-SUMMARY.md

# Phase 1 analytics functions we're calling
@.planning/phases/01-analytics-foundation/01-02-SUMMARY.md
@.planning/phases/01-analytics-foundation/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Server Action and analytics page</name>
  <files>web/app/admin/analytics/actions.ts, web/app/admin/analytics/page.tsx</files>
  <action>
    1. Create web/app/admin/analytics/actions.ts - Server Action for manual refresh:
       ```typescript
       'use server'

       import { revalidatePath } from 'next/cache'

       export async function refreshAnalytics() {
         revalidatePath('/admin/analytics')
       }
       ```

    2. Create web/app/admin/analytics/page.tsx - Server Component that fetches and renders analytics:
       ```typescript
       import { forbidden } from 'next/navigation'
       import { createClient } from '@/lib/supabase/server'
       import type {
         SummaryStats,
         PopularTrack,
         StreakDropoff,
         QuizCompletionRate,
         DateRange,
       } from '@/types/analytics'
       import { SummaryCards } from './_components/SummaryCards'
       import { PopularTracksChart } from './_components/PopularTracksChart'
       import { StreakDropoffsChart } from './_components/StreakDropoffsChart'
       import { QuizCompletionChart } from './_components/QuizCompletionChart'
       import { DateRangeFilter } from './_components/DateRangeFilter'
       import { RefreshButton } from './_components/RefreshButton'

       interface PageProps {
         searchParams: Promise<{ range?: string }>
       }

       export default async function AnalyticsPage({ searchParams }: PageProps) {
         const params = await searchParams
         const range = (params.range || '7d') as DateRange
         const supabase = await createClient()

         // Fetch summary stats - also validates admin access
         // RPC function throws "Access denied" if user is not admin
         const { data: summaryData, error: summaryError } = await supabase.rpc(
           'get_summary_stats'
         )

         if (summaryError) {
           if (summaryError.message.includes('Access denied')) {
             forbidden()
           }
           console.error('Error fetching summary stats:', summaryError)
           throw new Error('Failed to load analytics')
         }

         // Fetch all other analytics data in parallel
         const [tracksResult, streaksResult, quizResult] = await Promise.all([
           supabase.rpc('get_popular_tracks'),
           supabase.rpc('get_streak_dropoffs'),
           supabase.rpc('get_quiz_completion_rates'),
         ])

         // Type assertion - RPC returns array
         const summary = (summaryData as SummaryStats[])?.[0] || null
         const tracks = (tracksResult.data as PopularTrack[]) || []
         const streaks = (streaksResult.data as StreakDropoff[]) || []
         const quizRates = (quizResult.data as QuizCompletionRate[]) || []

         // Filter quiz data by date range (client-side filter on pre-aggregated weekly data)
         const filteredQuizRates = filterByDateRange(quizRates, range)

         return (
           <div className="space-y-8">
             <div className="flex items-center justify-between">
               <div>
                 <h1 className="text-2xl font-bold text-foreground">
                   Analytics Dashboard
                 </h1>
                 {summary?.refreshed_at && (
                   <p className="text-sm text-muted-foreground mt-1">
                     Last updated: {new Date(summary.refreshed_at).toLocaleString()}
                   </p>
                 )}
               </div>
               <div className="flex items-center gap-4">
                 <DateRangeFilter />
                 <RefreshButton />
               </div>
             </div>

             {summary && <SummaryCards data={summary} />}

             <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
               <div className="bg-card rounded-lg border border-muted p-6">
                 <h2 className="text-lg font-semibold mb-4">Popular Tracks</h2>
                 <PopularTracksChart data={tracks} />
               </div>

               <div className="bg-card rounded-lg border border-muted p-6">
                 <h2 className="text-lg font-semibold mb-4">Streak Drop-offs</h2>
                 <StreakDropoffsChart data={streaks} />
               </div>

               <div className="bg-card rounded-lg border border-muted p-6 lg:col-span-2">
                 <h2 className="text-lg font-semibold mb-4">
                   Quiz Completion Rate ({range === '1d' ? 'Today' : range === '7d' ? 'Last Week' : 'Last Month'})
                 </h2>
                 <QuizCompletionChart data={filteredQuizRates} />
               </div>
             </div>
           </div>
         )
       }

       // Filter weekly data based on date range
       function filterByDateRange(
         data: QuizCompletionRate[],
         range: DateRange
       ): QuizCompletionRate[] {
         const now = new Date()
         let cutoff: Date

         switch (range) {
           case '1d':
             cutoff = new Date(now.setDate(now.getDate() - 1))
             break
           case '7d':
             cutoff = new Date(now.setDate(now.getDate() - 7))
             break
           case '30d':
             cutoff = new Date(now.setDate(now.getDate() - 30))
             break
         }

         return data.filter((d) => new Date(d.week_start) >= cutoff)
       }
       ```

    NOTE: The page validates admin access by checking if get_summary_stats() returns error. The RPC function enforces is_admin() at database level (from Phase 1). If user is not admin, the function raises EXCEPTION with "Access denied" message.
  </action>
  <verify>
    - `cat web/app/admin/analytics/actions.ts` shows refreshAnalytics Server Action
    - `cat web/app/admin/analytics/page.tsx` shows AnalyticsPage with RPC calls
    - File contains `forbidden()` import and usage
    - File contains `supabase.rpc('get_summary_stats')`
  </verify>
  <done>
    - Server Action for manual refresh exists
    - Analytics page fetches data via RPC and renders components
    - Admin validation happens via RPC error handling (forbidden() on access denied)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create summary cards and chart components</name>
  <files>
    web/app/admin/analytics/_components/SummaryCards.tsx,
    web/app/admin/analytics/_components/PopularTracksChart.tsx,
    web/app/admin/analytics/_components/StreakDropoffsChart.tsx,
    web/app/admin/analytics/_components/QuizCompletionChart.tsx
  </files>
  <action>
    1. Create web/app/admin/analytics/_components/SummaryCards.tsx:
       ```typescript
       import type { SummaryStats } from '@/types/analytics'

       interface Props {
         data: SummaryStats
       }

       export function SummaryCards({ data }: Props) {
         const cards = [
           {
             label: 'Total Users',
             value: data.total_users.toLocaleString(),
             subtext: 'All time',
           },
           {
             label: 'Active Users (7d)',
             value: data.active_users_7d.toLocaleString(),
             subtext: 'Last 7 days',
           },
           {
             label: 'Active Users (30d)',
             value: data.active_users_30d.toLocaleString(),
             subtext: 'Last 30 days',
           },
           {
             label: 'Completion Rate',
             value: `${data.completion_rate_30d.toFixed(1)}%`,
             subtext: 'Last 30 days',
           },
           {
             label: 'Quiz Completion',
             value: `${data.quiz_completion_rate_30d.toFixed(1)}%`,
             subtext: 'Last 30 days',
           },
           {
             label: 'Review Completion',
             value: `${data.review_completion_rate_30d.toFixed(1)}%`,
             subtext: 'Last 30 days',
           },
         ]

         return (
           <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
             {cards.map((card) => (
               <div
                 key={card.label}
                 className="bg-card rounded-lg border border-muted p-4"
               >
                 <p className="text-sm text-muted-foreground">{card.label}</p>
                 <p className="text-2xl font-bold text-foreground mt-1">
                   {card.value}
                 </p>
                 <p className="text-xs text-muted-foreground mt-1">
                   {card.subtext}
                 </p>
               </div>
             ))}
           </div>
         )
       }
       ```

    2. Create web/app/admin/analytics/_components/PopularTracksChart.tsx:
       ```typescript
       'use client'

       import {
         BarChart,
         Bar,
         XAxis,
         YAxis,
         CartesianGrid,
         Tooltip,
         ResponsiveContainer,
       } from 'recharts'
       import type { PopularTrack } from '@/types/analytics'

       interface Props {
         data: PopularTrack[]
       }

       export function PopularTracksChart({ data }: Props) {
         if (data.length === 0) {
           return (
             <div className="h-64 flex items-center justify-center text-muted-foreground">
               No track data available
             </div>
           )
         }

         // Sort by total users and take top 10
         const chartData = [...data]
           .sort((a, b) => b.total_users - a.total_users)
           .slice(0, 10)
           .map((d) => ({
             name: d.track_title.length > 20
               ? d.track_title.slice(0, 20) + '...'
               : d.track_title,
             users: d.total_users,
             completionRate: d.completion_rate_pct,
           }))

         return (
           <div className="h-64">
             <ResponsiveContainer width="100%" height="100%">
               <BarChart data={chartData} layout="vertical">
                 <CartesianGrid strokeDasharray="3 3" stroke="hsl(var(--muted))" />
                 <XAxis type="number" stroke="hsl(var(--muted-foreground))" />
                 <YAxis
                   dataKey="name"
                   type="category"
                   width={150}
                   stroke="hsl(var(--muted-foreground))"
                   tick={{ fontSize: 12 }}
                 />
                 <Tooltip
                   contentStyle={{
                     backgroundColor: 'hsl(var(--card))',
                     border: '1px solid hsl(var(--muted))',
                     borderRadius: '8px',
                   }}
                   formatter={(value: number, name: string) => [
                     name === 'users' ? value.toLocaleString() : `${value.toFixed(1)}%`,
                     name === 'users' ? 'Total Users' : 'Completion Rate',
                   ]}
                 />
                 <Bar dataKey="users" fill="#D4A373" name="users" />
               </BarChart>
             </ResponsiveContainer>
           </div>
         )
       }
       ```

    3. Create web/app/admin/analytics/_components/StreakDropoffsChart.tsx:
       ```typescript
       'use client'

       import {
         AreaChart,
         Area,
         XAxis,
         YAxis,
         CartesianGrid,
         Tooltip,
         ResponsiveContainer,
       } from 'recharts'
       import type { StreakDropoff } from '@/types/analytics'

       interface Props {
         data: StreakDropoff[]
       }

       export function StreakDropoffsChart({ data }: Props) {
         if (data.length === 0) {
           return (
             <div className="h-64 flex items-center justify-center text-muted-foreground">
               No streak data available
             </div>
           )
         }

         const chartData = data
           .sort((a, b) => a.days_before_dropoff - b.days_before_dropoff)
           .map((d) => ({
             day: d.days_before_dropoff,
             streaksEnded: d.num_streaks_ended,
             percentage: d.percentage,
           }))

         return (
           <div className="h-64">
             <ResponsiveContainer width="100%" height="100%">
               <AreaChart data={chartData}>
                 <CartesianGrid strokeDasharray="3 3" stroke="hsl(var(--muted))" />
                 <XAxis
                   dataKey="day"
                   stroke="hsl(var(--muted-foreground))"
                   label={{
                     value: 'Days Before Drop-off',
                     position: 'insideBottom',
                     offset: -5,
                   }}
                 />
                 <YAxis
                   stroke="hsl(var(--muted-foreground))"
                   label={{
                     value: 'Streaks Ended',
                     angle: -90,
                     position: 'insideLeft',
                   }}
                 />
                 <Tooltip
                   contentStyle={{
                     backgroundColor: 'hsl(var(--card))',
                     border: '1px solid hsl(var(--muted))',
                     borderRadius: '8px',
                   }}
                   formatter={(value: number, name: string) => [
                     name === 'streaksEnded'
                       ? value.toLocaleString()
                       : `${value.toFixed(1)}%`,
                     name === 'streaksEnded' ? 'Streaks Ended' : 'Percentage',
                   ]}
                 />
                 <Area
                   type="monotone"
                   dataKey="streaksEnded"
                   stroke="#D4A373"
                   fill="#D4A373"
                   fillOpacity={0.3}
                 />
               </AreaChart>
             </ResponsiveContainer>
           </div>
         )
       }
       ```

    4. Create web/app/admin/analytics/_components/QuizCompletionChart.tsx:
       ```typescript
       'use client'

       import {
         LineChart,
         Line,
         XAxis,
         YAxis,
         CartesianGrid,
         Tooltip,
         Legend,
         ResponsiveContainer,
       } from 'recharts'
       import { format } from 'date-fns'
       import type { QuizCompletionRate } from '@/types/analytics'

       interface Props {
         data: QuizCompletionRate[]
       }

       export function QuizCompletionChart({ data }: Props) {
         if (data.length === 0) {
           return (
             <div className="h-64 flex items-center justify-center text-muted-foreground">
               No quiz data available for this period
             </div>
           )
         }

         const chartData = data
           .sort(
             (a, b) =>
               new Date(a.week_start).getTime() - new Date(b.week_start).getTime()
           )
           .map((d) => ({
             week: format(new Date(d.week_start), 'MMM dd'),
             completionRate: d.completion_rate_pct,
             totalQuizzes: d.total_quizzes,
             completedQuizzes: d.completed_quizzes,
           }))

         return (
           <div className="h-64">
             <ResponsiveContainer width="100%" height="100%">
               <LineChart data={chartData}>
                 <CartesianGrid strokeDasharray="3 3" stroke="hsl(var(--muted))" />
                 <XAxis dataKey="week" stroke="hsl(var(--muted-foreground))" />
                 <YAxis
                   domain={[0, 100]}
                   stroke="hsl(var(--muted-foreground))"
                   label={{
                     value: 'Completion %',
                     angle: -90,
                     position: 'insideLeft',
                   }}
                 />
                 <Tooltip
                   contentStyle={{
                     backgroundColor: 'hsl(var(--card))',
                     border: '1px solid hsl(var(--muted))',
                     borderRadius: '8px',
                   }}
                   formatter={(value: number, name: string) => {
                     if (name === 'completionRate') {
                       return [`${value.toFixed(1)}%`, 'Completion Rate']
                     }
                     return [value.toLocaleString(), name]
                   }}
                 />
                 <Legend />
                 <Line
                   type="monotone"
                   dataKey="completionRate"
                   stroke="#D4A373"
                   strokeWidth={2}
                   dot={{ fill: '#D4A373' }}
                   name="Completion Rate (%)"
                 />
               </LineChart>
             </ResponsiveContainer>
           </div>
         )
       }
       ```
  </action>
  <verify>
    - `ls web/app/admin/analytics/_components/` shows 4 component files
    - `grep "use client" web/app/admin/analytics/_components/*.tsx` shows client directive in chart components
    - `grep "BarChart" web/app/admin/analytics/_components/PopularTracksChart.tsx` confirms Recharts usage
  </verify>
  <done>
    - SummaryCards component displays KPI cards
    - PopularTracksChart shows horizontal bar chart of track engagement
    - StreakDropoffsChart shows area chart of streak patterns
    - QuizCompletionChart shows line chart of weekly quiz completion trends
  </done>
</task>

<task type="auto">
  <name>Task 3: Create date range filter and refresh button</name>
  <files>
    web/app/admin/analytics/_components/DateRangeFilter.tsx,
    web/app/admin/analytics/_components/RefreshButton.tsx
  </files>
  <action>
    1. Create web/app/admin/analytics/_components/DateRangeFilter.tsx:
       ```typescript
       'use client'

       import { useRouter, useSearchParams } from 'next/navigation'
       import type { DateRange } from '@/types/analytics'

       export function DateRangeFilter() {
         const router = useRouter()
         const searchParams = useSearchParams()
         const currentRange = (searchParams.get('range') || '7d') as DateRange

         const handleChange = (range: DateRange) => {
           const params = new URLSearchParams(searchParams.toString())
           params.set('range', range)
           router.push(`/admin/analytics?${params.toString()}`)
         }

         return (
           <select
             value={currentRange}
             onChange={(e) => handleChange(e.target.value as DateRange)}
             className="px-4 py-2 bg-card border border-muted rounded-lg text-foreground text-sm focus:outline-none focus:ring-2 focus:ring-accent"
           >
             <option value="1d">Last Day</option>
             <option value="7d">Last Week</option>
             <option value="30d">Last Month</option>
           </select>
         )
       }
       ```

    2. Create web/app/admin/analytics/_components/RefreshButton.tsx:
       ```typescript
       'use client'

       import { useState, useTransition } from 'react'
       import { refreshAnalytics } from '../actions'

       export function RefreshButton() {
         const [isPending, startTransition] = useTransition()

         const handleRefresh = () => {
           startTransition(async () => {
             await refreshAnalytics()
           })
         }

         return (
           <button
             onClick={handleRefresh}
             disabled={isPending}
             className="px-4 py-2 bg-accent text-white rounded-lg text-sm font-medium hover:opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed"
           >
             {isPending ? 'Refreshing...' : 'Refresh'}
           </button>
         )
       }
       ```
  </action>
  <verify>
    - `cat web/app/admin/analytics/_components/DateRangeFilter.tsx` shows useSearchParams usage
    - `cat web/app/admin/analytics/_components/RefreshButton.tsx` shows refreshAnalytics import
    - TypeScript compiles: `cd web && npx tsc --noEmit`
  </verify>
  <done>
    - DateRangeFilter updates URL query params for filtering
    - RefreshButton triggers Server Action to revalidate page data
    - Both components styled consistently with admin theme
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **File structure:**
   ```bash
   tree web/app/admin/analytics/
   # Should show page.tsx, actions.ts, and _components/ with 6 files
   ```

2. **TypeScript compilation:**
   ```bash
   cd web && npx tsc --noEmit
   ```

3. **Development server test:**
   ```bash
   cd web && npm run dev &
   sleep 5
   # Should redirect to login (not authenticated)
   curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/admin/analytics
   # Expected: 307 (redirect)
   ```

4. **Component imports verify:**
   ```bash
   grep -l "recharts" web/app/admin/analytics/_components/*.tsx
   # Should list chart components
   ```
</verification>

<success_criteria>
- /admin/analytics page exists and renders (for admin users)
- Non-admin authenticated users see 403 page
- Summary cards display 6 KPI metrics
- Popular tracks chart shows horizontal bar chart
- Streak dropoffs chart shows area chart
- Quiz completion chart shows line chart with date-based filtering
- Date range filter changes URL params and re-renders page
- Refresh button triggers data refresh via Server Action
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-admin-dashboard/02-02-SUMMARY.md`
</output>
