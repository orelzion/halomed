# Maestro E2E Test: PowerSync Integration
# Task 8.4a - Client Testing Agent
# 
# This test validates that PowerSync is properly integrated:
# - PowerSync connection is established
# - Database is accessible (can read data)
# - Schema is initialized (tables exist)
# - Data can be written (completion sync)
# - Changes persist (offline-first)

url: "http://localhost:3000"
---
# Launch and authenticate
- launchApp
- runFlow: auth_anonymous.yaml

# Test 1: PowerSync connection - verify data loads (reads from PowerSync database)
# If PowerSync isn't connected, tracks won't load
- assertVisible:
    text: "הלומד"

# Test 2: Database read - verify tracks are loaded from PowerSync
# This validates that PowerSync schema is initialized and data is accessible
- assertVisible:
    id: "track_card"

# Test 3: Navigate to study (validates PowerSync data access works)
- tapOn:
    id: "track_card"

# Test 4: Verify study content loads (validates content_cache table access)
- assertVisible:
    id: "study_screen"
- assertVisible:
    id: "mishna_text"

# Test 5: Database write - mark completion (writes to user_study_log table)
# This validates that PowerSync can write data locally
- assertVisible:
    id: "done_button"
- tapOn:
    id: "done_button"

# Test 6: Verify write succeeded (data persisted in PowerSync)
- assertVisible:
    text: "✓ סיימתי"

# Test 7: Verify data persists - go back and return
- back
- assertVisible:
    id: "track_card"
- tapOn:
    id: "track_card"

# Test 8: Verify completion state persisted (validates PowerSync local storage)
- assertVisible:
    text: "✓ סיימתי"

# Note: Full sync testing (client-to-server) requires:
# - Network connectivity
# - PowerSync connector properly configured
# - Supabase backend sync rules
# This test validates local PowerSync functionality (offline-first architecture)

- killApp